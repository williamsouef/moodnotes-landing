<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodly Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">Moodly TestFlight Signups</div>
            <a href="#" class="admin-logout" id="logout-btn">Logout</a>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-signups">--</div>
                <div class="stat-label">Total Signups</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="today-signups">--</div>
                <div class="stat-label">Today's Signups</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="conversion-rate">--</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>

        <div class="emails-table-container">
            <div class="emails-table-header">
                <h2>Email Signups</h2>
                <div class="table-actions">
                    <button id="refresh-btn" class="action-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="export-btn" class="action-btn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                </div>
            </div>
            <table class="emails-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Device</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="emails-table-body">
                    <!-- Table rows will be generated by JavaScript -->
                    <tr>
                        <td colspan="5" class="loading-msg">Loading data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated
            const isAuthenticated = localStorage.getItem('moodlyAdminAuth') === 'true';
            if (!isAuthenticated) {
                window.location.href = 'admin.html';
                return;
            }

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('moodlyAdminAuth');
                window.location.href = 'admin.html';
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', function() {
                fetchEmailData();
            });

            // Export to CSV
            document.getElementById('export-btn').addEventListener('click', function() {
                exportToCsv();
            });

            // Fetch initial data
            fetchEmailData();

            // Function to fetch email data from Firebase
            function fetchEmailData() {
                const tableBody = document.getElementById('emails-table-body');
                tableBody.innerHTML = '<tr><td colspan="5" class="loading-msg">Loading data...</td></tr>';
                
                // Combiner les emails du backend avec ceux stockés localement
                Promise.all([
                    // Essayer de récupérer depuis Firebase
                    fetch('https://moodly-emails-default-rtdb.firebaseio.com/emails.json')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .catch(error => {
                            console.error('Error fetching from Firebase:', error);
                            return null; // Retourner null en cas d'erreur
                        }),
                    // Récupérer depuis localStorage
                    new Promise(resolve => {
                        const localEmails = JSON.parse(localStorage.getItem('moodlyEmails') || '[]');
                        resolve(localEmails);
                    })
                ])
                .then(([firebaseData, localEmails]) => {
                    let allEmails = [];
                    
                    // Traiter les données Firebase si disponibles
                    if (firebaseData) {
                        for (const key in firebaseData) {
                            if (firebaseData.hasOwnProperty(key)) {
                                allEmails.push({
                                    id: key,
                                    source: 'Firebase',
                                    ...firebaseData[key]
                                });
                            }
                        }
                    }
                    
                    // Ajouter les emails locaux
                    localEmails.forEach(email => {
                        allEmails.push({
                            source: 'Local Storage',
                            ...email
                        });
                    });
                    
                    if (allEmails.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="5" class="empty-msg">No data available</td></tr>';
                        updateStats(0, 0);
                        return;
                    }

                    // Trier par timestamp (plus récent d'abord)
                    allEmails.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Mettre à jour le tableau
                    updateTable(allEmails);
                    
                    // Mettre à jour les statistiques
                    updateStats(allEmails.length, countTodaySignups(allEmails));
                })
                .catch(error => {
                    console.error('Error processing data:', error);
                    tableBody.innerHTML = '<tr><td colspan="5" class="error-msg">Error loading data. Please try again.</td></tr>';
                });
            }

            // Function to update the table with email data
            function updateTable(emails) {
                const tableBody = document.getElementById('emails-table-body');
                tableBody.innerHTML = '';

                if (emails.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="empty-msg">No data available</td></tr>';
                    return;
                }

                // Mise à jour des en-têtes du tableau pour inclure la source
                const tableHead = document.querySelector('.emails-table thead tr');
                if (tableHead && tableHead.querySelectorAll('th').length === 4) {
                    tableHead.innerHTML = `
                        <th>Email</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Device</th>
                        <th>Source</th>
                    `;
                }

                emails.forEach(item => {
                    const date = new Date(item.timestamp);
                    const row = document.createElement('tr');
                    
                    // Format date: YYYY-MM-DD
                    const dateStr = date.toISOString().split('T')[0];
                    
                    // Format time: HH:MM:SS
                    const timeStr = date.toTimeString().split(' ')[0];
                    
                    // Detect device type from user agent
                    const deviceType = detectDeviceType(item.userAgent);
                    
                    // Source (Firebase ou Local Storage)
                    const source = item.source || 'Unknown';
                    
                    row.innerHTML = `
                        <td>${item.email}</td>
                        <td>${dateStr}</td>
                        <td>${timeStr}</td>
                        <td>${deviceType}</td>
                        <td>${source}</td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            // Function to detect device type from user agent
            function detectDeviceType(userAgent) {
                if (!userAgent) return 'Unknown';
                
                if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(userAgent)) {
                    return 'Tablet';
                }
                if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(userAgent)) {
                    return 'Mobile';
                }
                return 'Desktop';
            }

            // Count signups from today
            function countTodaySignups(emails) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return emails.filter(item => {
                    const date = new Date(item.timestamp);
                    return date >= today;
                }).length;
            }

            // Update the stats section
            function updateStats(total, today) {
                document.getElementById('total-signups').textContent = total;
                document.getElementById('today-signups').textContent = today;
                
                // Calculate a simple conversion rate (this would be more accurate with visitor data)
                // Here we're just using a mock value
                const conversionRate = total > 0 ? ((total / 100) * 100).toFixed(1) + '%' : '0%';
                document.getElementById('conversion-rate').textContent = conversionRate;
            }

            // Export data to CSV
            function exportToCsv() {
                fetch('https://moodly-emails-default-rtdb.firebaseio.com/emails.json')
                    .then(response => response.json())
                    .then(data => {
                        if (!data) {
                            alert('No data to export');
                            return;
                        }

                        const emails = [];
                        for (const key in data) {
                            if (data.hasOwnProperty(key)) {
                                emails.push(data[key]);
                            }
                        }

                        // Create CSV content
                        let csvContent = "data:text/csv;charset=utf-8,";
                        csvContent += "Email,Timestamp,User Agent,Referrer\n";
                        
                        emails.forEach(item => {
                            csvContent += `${item.email},${item.timestamp},"${item.userAgent || ''}","${item.referrer || ''}"\n`;
                        });
                        
                        // Create download link
                        const encodedUri = encodeURI(csvContent);
                        const link = document.createElement("a");
                        link.setAttribute("href", encodedUri);
                        link.setAttribute("download", `moodly-signups-${new Date().toISOString().split('T')[0]}.csv`);
                        document.body.appendChild(link);
                        
                        // Download file
                        link.click();
                    })
                    .catch(error => {
                        console.error('Error exporting data:', error);
                        alert('Error exporting data. Please try again.');
                    });
            }
        });
    </script>

    <style>
        /* Additional dashboard styles */
        .loading-msg, .empty-msg, .error-msg {
            text-align: center;
            padding: 20px;
            color: var(--text-light-secondary);
        }

        .error-msg {
            color: #FA7070;
        }

        .emails-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .emails-table-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background-color: var(--dark-card-light);
            border: none;
            color: var(--text-light);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
        }

        .admin-login-footer {
            margin-top: 20px;
            text-align: center;
        }

        .admin-login-footer a {
            color: var(--text-light-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .admin-login-footer a:hover {
            color: var(--primary-color);
        }
    </style>
</body>
</html>
