<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moodly Admin Dashboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <div class="admin-title">Moodly TestFlight Signups</div>
            <a href="#" class="admin-logout" id="logout-btn">Logout</a>
        </div>

        <div class="admin-stats">
            <div class="stat-card">
                <div class="stat-value" id="total-signups">--</div>
                <div class="stat-label">Total Signups</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="today-signups">--</div>
                <div class="stat-label">Today's Signups</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="conversion-rate">--</div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>

        <div class="emails-table-container">
            <div class="emails-table-header">
                <h2>Email Signups</h2>
                <div class="table-actions">
                    <button id="refresh-btn" class="action-btn">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="export-btn" class="action-btn">
                        <i class="fas fa-download"></i> Export CSV
                    </button>
                    <button id="test-data-btn" class="action-btn">
                        <i class="fas fa-vial"></i> Load Test Data
                    </button>
                </div>
            </div>
            <table class="emails-table">
                <thead>
                    <tr>
                        <th>Email</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Device</th>
                        <th>Source</th>
                    </tr>
                </thead>
                <tbody id="emails-table-body">
                    <!-- Table rows will be generated by JavaScript -->
                    <tr>
                        <td colspan="5" class="loading-msg">Loading data...</td>
                    </tr>
                    <tr style="display: none;">
                        <td colspan="5" class="empty-msg">No data available</td>
                    </tr>
                    <tr style="display: none;">
                        <td colspan="5" class="error-msg">Error loading data. Please try again.</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is authenticated
            const isAuthenticated = localStorage.getItem('moodlyAdminAuth') === 'true';
            if (!isAuthenticated) {
                window.location.href = 'admin.html';
                return;
            }

            // Logout functionality
            document.getElementById('logout-btn').addEventListener('click', function(e) {
                e.preventDefault();
                localStorage.removeItem('moodlyAdminAuth');
                window.location.href = 'admin.html';
            });

            // Refresh button
            document.getElementById('refresh-btn').addEventListener('click', function() {
                fetchEmailData();
            });

            // Export to CSV
            document.getElementById('export-btn').addEventListener('click', function() {
                exportToCsv();
            });

            // Test data button
            document.getElementById('test-data-btn').addEventListener('click', function() {
                addTestData();
                fetchEmailData();
            });

            // Fetch initial data
            fetchEmailData();

            // Function to fetch email data
            function fetchEmailData() {
                const emailsTableBody = document.getElementById('emails-table-body');
                const loadingMsg = emailsTableBody.querySelector('.loading-msg');
                const emptyMsg = emailsTableBody.querySelector('.empty-msg');
                const errorMsg = emailsTableBody.querySelector('.error-msg');

                // Reset all messages
                if (loadingMsg) loadingMsg.parentNode.style.display = 'table-row';
                if (emptyMsg) emptyMsg.parentNode.style.display = 'none';
                if (errorMsg) errorMsg.parentNode.style.display = 'none';
                
                console.log("Fetching email data...");

                // Add a cache-busting parameter to ensure fresh data
                Promise.all([
                    // Try to fetch from Firebase with cache-busting
                    fetch(`https://moodly-emails-default-rtdb.firebaseio.com/emails.json?timestamp=${new Date().getTime()}`)
                        .then(response => {
                            console.log("Firebase response:", response);
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Firebase data:", data);
                            return data;
                        })
                        .catch(error => {
                            console.error('Error fetching from Firebase:', error);
                            return null;
                        }),
                    // Get from localStorage
                    new Promise(resolve => {
                        const localEmails = JSON.parse(localStorage.getItem('moodlyEmails') || '[]');
                        console.log("Local storage emails:", localEmails);
                        resolve(localEmails);
                    })
                ])
                .then(([firebaseData, localEmails]) => {
                    let allEmails = [];
                    
                    // Process Firebase data if available
                    if (firebaseData) {
                        for (const key in firebaseData) {
                            if (firebaseData.hasOwnProperty(key)) {
                                allEmails.push({
                                    id: key,
                                    source: 'Firebase',
                                    ...firebaseData[key]
                                });
                            }
                        }
                    }
                    
                    // Add local emails
                    localEmails.forEach(email => {
                        allEmails.push({
                            source: 'Local Storage',
                            ...email
                        });
                    });
                    
                    console.log("All emails combined:", allEmails);
                    
                    if (allEmails.length === 0) {
                        console.log("No emails found");
                        if (loadingMsg) loadingMsg.parentNode.style.display = 'none';
                        if (emptyMsg) emptyMsg.parentNode.style.display = 'table-row';
                        updateStats(0, 0);
                        return;
                    }

                    // Sort by timestamp (most recent first)
                    allEmails.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    // Clear loading message
                    if (loadingMsg) loadingMsg.parentNode.style.display = 'none';
                    
                    // Update the table
                    updateTable(allEmails);
                    
                    // Update statistics
                    updateStats(allEmails.length, countTodaySignups(allEmails));
                })
                .catch(error => {
                    console.error('Error processing data:', error);
                    if (loadingMsg) loadingMsg.parentNode.style.display = 'none';
                    if (errorMsg) errorMsg.parentNode.style.display = 'table-row';
                });
            }

            // Function to update the table with email data
            function updateTable(emails) {
                const emailsTableBody = document.getElementById('emails-table-body');
                // Remove all data rows but keep the message rows
                const messageRows = emailsTableBody.querySelectorAll('.loading-msg, .empty-msg, .error-msg');
                Array.from(messageRows).forEach(row => {
                    row.closest('tr').style.display = 'none';
                });
                
                // Remove any existing data rows
                const dataRows = Array.from(emailsTableBody.querySelectorAll('tr')).filter(row => 
                    !row.querySelector('.loading-msg') && 
                    !row.querySelector('.empty-msg') && 
                    !row.querySelector('.error-msg')
                );
                dataRows.forEach(row => row.remove());

                if (emails.length === 0) {
                    // Show empty message
                    const emptyRow = emailsTableBody.querySelector('.empty-msg').closest('tr');
                    if (emptyRow) emptyRow.style.display = 'table-row';
                    return;
                }

                // Ensure the table headers are correct
                const tableHead = document.querySelector('.emails-table thead tr');
                if (tableHead) {
                    // Always make sure we have the right number of columns
                    tableHead.innerHTML = `
                        <th>Email</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Device</th>
                        <th>Source</th>
                    `;
                }

                // Add data rows
                emails.forEach(item => {
                    const date = new Date(item.timestamp);
                    const row = document.createElement('tr');
                    
                    // Format date: YYYY-MM-DD
                    const dateStr = date.toISOString().split('T')[0];
                    
                    // Format time: HH:MM:SS
                    const timeStr = date.toTimeString().split(' ')[0];
                    
                    // Detect device type from user agent
                    const deviceType = detectDeviceType(item.userAgent);
                    
                    // Source (Firebase or Local Storage)
                    const source = item.source || 'Unknown';
                    
                    row.innerHTML = `
                        <td>${item.email}</td>
                        <td>${dateStr}</td>
                        <td>${timeStr}</td>
                        <td>${deviceType}</td>
                        <td>${source}</td>
                    `;
                    emailsTableBody.appendChild(row);
                });
                
                console.log(`Displayed ${emails.length} emails in the table`);
            }

            // Function to detect device type from user agent
            function detectDeviceType(userAgent) {
                if (!userAgent) return 'Unknown';
                
                if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(userAgent)) {
                    return 'Tablet';
                }
                if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(userAgent)) {
                    return 'Mobile';
                }
                return 'Desktop';
            }

            // Count signups from today
            function countTodaySignups(emails) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                return emails.filter(item => {
                    const date = new Date(item.timestamp);
                    return date >= today;
                }).length;
            }

            // Update the stats section
            function updateStats(total, today) {
                document.getElementById('total-signups').textContent = total;
                document.getElementById('today-signups').textContent = today;
                
                // Calculate a simple conversion rate (this would be more accurate with visitor data)
                // Here we're just using a mock value
                const conversionRate = total > 0 ? ((total / 100) * 100).toFixed(1) + '%' : '0%';
                document.getElementById('conversion-rate').textContent = conversionRate;
            }

            // Export data to CSV
            function exportToCsv() {
                console.log("Starting CSV export...");
                // Get emails from Firebase and localStorage
                Promise.all([
                    // Try to fetch from Firebase with cache-busting
                    fetch(`https://moodly-emails-default-rtdb.firebaseio.com/emails.json?timestamp=${new Date().getTime()}`)
                        .then(response => {
                            console.log("Firebase response for export:", response);
                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log("Firebase data for export:", data);
                            return data;
                        })
                        .catch(error => {
                            console.error('Error fetching from Firebase for export:', error);
                            return null;
                        }),
                    // Get from localStorage
                    new Promise(resolve => {
                        const localEmails = JSON.parse(localStorage.getItem('moodlyEmails') || '[]');
                        console.log("Local storage emails for export:", localEmails);
                        resolve(localEmails);
                    })
                ])
                .then(([firebaseData, localEmails]) => {
                    let allEmails = [];
                    
                    // Process Firebase data if available
                    if (firebaseData) {
                        for (const key in firebaseData) {
                            if (firebaseData.hasOwnProperty(key)) {
                                allEmails.push({
                                    id: key,
                                    source: 'Firebase',
                                    ...firebaseData[key]
                                });
                            }
                        }
                    }
                    
                    // Add local emails
                    localEmails.forEach(email => {
                        allEmails.push({
                            source: 'Local Storage',
                            ...email
                        });
                    });
                    
                    console.log(`Total emails for export: ${allEmails.length}`);
                    
                    if (allEmails.length === 0) {
                        alert('No data to export');
                        return;
                    }

                    // Create CSV content
                    let csvContent = "data:text/csv;charset=utf-8,";
                    csvContent += "Email,Timestamp,Source,Device,Referrer\n";
                    
                    allEmails.forEach(item => {
                        const deviceType = detectDeviceType(item.userAgent);
                        csvContent += `"${item.email}","${item.timestamp}","${item.source || 'Unknown'}","${deviceType}","${item.referrer || ''}"\n`;
                    });
                    
                    // Create download link
                    const encodedUri = encodeURI(csvContent);
                    const link = document.createElement("a");
                    link.setAttribute("href", encodedUri);
                    link.setAttribute("download", `moodly-signups-${new Date().toISOString().split('T')[0]}.csv`);
                    document.body.appendChild(link);
                    
                    // Download file
                    link.click();
                })
                .catch(error => {
                    console.error('Error exporting data:', error);
                    alert('Error exporting data. Please try again.');
                });
            }

            // Add test data for debugging
            function addTestData() {
                console.log("Adding test data to localStorage");
                const testEmails = [
                    {
                        email: "test1@example.com",
                        timestamp: new Date().toISOString(),
                        source: "direct",
                        userAgent: navigator.userAgent
                    },
                    {
                        email: "test2@example.com",
                        timestamp: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        source: "direct",
                        userAgent: navigator.userAgent
                    },
                    {
                        email: "test3@example.com", 
                        timestamp: new Date().toISOString(),
                        source: "direct",
                        userAgent: "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/14.0 Mobile/15E148 Safari/604.1"
                    }
                ];
                
                localStorage.setItem('moodlyEmails', JSON.stringify(testEmails));
                alert('Test data loaded. You should now see 3 test emails in the table.');
            }
        });
    </script>

    <style>
        /* Additional dashboard styles */
        .loading-msg, .empty-msg, .error-msg {
            text-align: center;
            padding: 20px;
            color: var(--text-light-secondary);
        }

        .error-msg {
            color: #FA7070;
        }

        .emails-table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .emails-table-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .table-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background-color: var(--dark-card-light);
            border: none;
            color: var(--text-light);
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
        }

        .action-btn:hover {
            background-color: var(--primary-color);
        }

        .admin-login-footer {
            margin-top: 20px;
            text-align: center;
        }

        .admin-login-footer a {
            color: var(--text-light-secondary);
            text-decoration: none;
            font-size: 14px;
            transition: color 0.3s;
        }

        .admin-login-footer a:hover {
            color: var(--primary-color);
        }
    </style>
</body>
</html>
